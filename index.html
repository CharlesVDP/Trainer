<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
	<meta charset="utf-8" />
	<title>Data Collector</title>
	<style>
		.target {
			width: 5vmin;
			height: 5vmin;
			position: fixed;
			display: none;
			border-radius: 5vmin;
		}

		body {
			width: 100vw;
			height: 100vh;
		}

		#stop {
			display: none;
		}

		.custom-border-radius {
			border-top-left-radius: 0px;
			border-top-right-radius: 0px;
			border-bottom-left-radius: 10px;
			border-bottom-right-radius: 10px;
			border-top: none;
		}

		.btn {
			width: 15vw;
		}

		.crosshair {
			cursor: crosshair;
			cursor: url(crosshairs/default.png);
		}

		.header{
			height: 5vh;
		}

		.canvas{
			height: 95vh;
		}
	</style>
</head>
<body>
	<div class="modal fade" id="scoreboard" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				
				<div class="modal-body align-items-center">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h5 class="text-secondary">Score: <span class="score">0</span></h5>
					<h5 class="text-secondary">Accuracy: <span class="accuracy">0</span>%</h5>
					<h5 class="text-secondary">Hits: <span class="hits">0</span></h5>
					<h5 class="text-secondary">Misses: <span class="misses">0</span></h5>
					<h5 class="text-secondary">Avg. Time to Kill: <span class="ttk">0</span>ms</h5>
				</div>
				<div class="modal-footer justify-content-between border-top-0">
					<button id="reset" type="button" class="btn btn-outline-secondary" data-dismiss="modal">Reset</button>
					<button id="download" type="button" class="btn btn-outline-info">Download Mouse Data</button>
				</div>
			</div>
		</div>
	</div>

	<div class="container-fluid header">
		<div class="row align-items-center justify-content-between">
			<div class="col text-left">
				<h5 class="text-secondary">Score: <span class="score">0</span></h5>
			</div>
			<div class="col-auto">
				<button id="start" class="btn btn-sm btn-outline-info custom-border-radius">Start</button>
				<button id="stop" class="btn btn-sm btn-outline-danger custom-border-radius">Stop</button>
			</div>
			<div class="col text-right">
				<h5 class="text-secondary">Accuracy: <span class="accuracy">0</span>%</h5>
			</div>
		</div>
	</div>
	<div class="canvas crosshair"></div>
</body>
</html>

<script type="text/javascript">
	$(function () {
		let started = false;
		let data = [];
		let row = [];
		let hits = 1;
		let shots = 1;
		let score = 0;
		let totalTtk = 0;

		let start = Date.now();

		function spawnTarget() {
			let x = (Math.random() * 95).toFixed(0);
			let y = Math.max(10, (Math.random() * 95).toFixed(0));
			$('body').append(`<div class="target bg-info crosshair" style="left:${x}vw; top:${y}vh;"></div>`);
			$('.target').fadeIn(50);
			start = Date.now();
		}

		function updateAccuracy() {
			let accuracy = ((hits / shots) * 100).toFixed(1);
			$('.accuracy').html(accuracy);
			$('.hits').html(hits);
			$('.misses').html(shots - hits);
		}

		function updateScore() {
			score += 100
			$('.score').html(Math.round(score * (hits / shots)));
		}

		function updateTimeToKill() {
			let ttk = Date.now() - start;
			totalTtk += ttk;

			let avgTtk = (totalTtk / hits).toFixed(0);
			$('.ttk').html(avgTtk);
		}

		$(document).on('click', '.target', function () {
			let audio = new Audio('sounds/hitmarker.ogg');
			audio.play();
			$(this).fadeOut(200);
			$(this).remove();
			hits++;
			updateTimeToKill();
			updateScore();
			spawnTarget();
		});

		$(document).on('click', function () {
			if (started && row.length > 0) {
				data.push(row);
				row = [];
				shots++;
				updateAccuracy();
			}
		});

		$('body').on('mousemove', function (e) {
			let x = e.screenX;
			let y = e.screenY;

			if (started) {
				row.push([x, y]);
			}
		});

		$('body').on('mouseleave', function () {
			row = [];
		});

		$('#start').on('click', function (e) {
			e.stopPropagation();
			started = true;
			spawnTarget();
			$(this).hide();
			$('#stop').fadeIn(250);
		});

		$('#stop').on('click', function (e) {
			e.stopPropagation();
			$('#scoreboard').modal('show');
			started = false;
			$(this).hide();
			$('.target').remove();
			$('#start').fadeIn(250);
		})

		$('#download').on('click', function () {
			download();
		});

		$('#reset').on('click', function () {
			$('.accuracy').html(0);
			$('.hits').html(1);
			$('.misses').html(1);
			$('.score').html(0);
			data = [];
			row = [];
			score = 0;
			hits = 0;
			shots = 0;
			totalTtk = 0;
		});

		function download() {
			let json = {};
			json['data'] = data;
			let jsons = JSON.stringify(json);
			var hiddenElement = document.createElement('a');
			hiddenElement.href = 'data:text/json;charset=utf-8,' + encodeURI(jsons);
			hiddenElement.target = '_blank';
			hiddenElement.download = 'data.JSON';
			hiddenElement.click();
		}
	})
</script>